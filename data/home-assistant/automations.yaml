- id: goodnight
  alias: Goodnight
  trigger:
    platform: event
    event_type: call_service
    event_data:
      service_data:
        entity_id: scene.goodnight_house
      domain: scene
      service: turn_on
  action:
    - service: rest_command.alarm_stay
    - service: climate.set_temperature
      data_template:
        entity_id: group.climate_control
        temperature: >-
          {%- if states('sensor.pws_temp_low_1d_f') | int > 69 -%}
            74
          {%- else -%}
            70
          {%- endif -%}
    - service: climate.set_operation_mode
      data_template:
        entity_id: climate.playroom
        operation_mode: >-
          {%- if states('sensor.pws_temp_low_1d_f') | int > 69 -%}
            cool
          {%- else -%}
            heat
          {%- endif -%}

- id: wakeup
  alias: Wakeup
  trigger:
    platform: time
    at: '06:20:00'
  action:
    - service: rest_command.alarm_disarm
    - service: lock.unlock
      entity_id: lock.garage_door_locked
    - service: climate.set_temperature
      data_template:
        entity_id: group.climate_control
        temperature: >-
          {%- if states('sensor.pws_temp_high_1d_f') | int > 74 -%}
            77
          {%- else -%}
            74
          {%- endif -%}
    - service: climate.set_operation_mode
      data_template:
        entity_id: climate.playroom
        operation_mode: >-
          {%- if states('sensor.pws_temp_high_1d_f') | int > 74 -%}
            cool
          {%- else -%}
            heat
          {%- endif -%}
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
    - service: switch.turn_on
      entity_id:
        - switch.kitchen_cabinet_lights_switch
        - switch.mudroom_hallway_lights_switch

- id: evening
  alias: Evening
  trigger:
    platform: time
    at: '16:45:00'
  action:
    - service: switch.turn_on
      entity_id: switch.kitchen_cabinet_lights_switch
    - service: climate.set_temperature
      data_template:
        entity_id: climate.playroom
        temperature: >-
          {%- if states('sensor.pws_temp_low_1d_f') | int > 69 -%}
            74
          {%- else -%}
            70
          {%- endif -%}
    - service: climate.set_operation_mode
      data_template:
        entity_id: climate.playroom
        operation_mode: >-
          {%- if states('sensor.pws_temp_low_1d_f') | int > 69 -%}
            cool
          {%- else -%}
            heat
          {%- endif -%}

- id: sunrise
  alias: Sunrise
  trigger:
    platform: sun
    event: sunrise
  action:
    service: switch.turn_off
    entity_id: group.outdoor_lights

- id: before_sunset
  alias: Before sunset
  trigger:
    platform: sun
    event: sunset
    offset: '-00:40:00'
  action:
    - service: switch.turn_on
      entity_id:
        - group.outdoor_lights
        - switch.step_lights_switch
    - service: light.turn_on
      data:
        entity_id:
          - light.master_bedroom_lamp_level
        brightness_pct: 100

- id: wakeup_teardown
  alias: Wakeup teardown
  trigger:
    platform: time
    at: '08:20:00'
  condition:
    condition: time
    weekday:
      - mon
      - tue
      - wed
      - thu
      - fri
  action:
    service: switch.turn_off
    entity_id:
      - switch.kitchen_cabinet_lights_switch
      - switch.mudroom_hallway_lights_switch
      - switch.step_lights_switch

- id: left_garage_door_timeout
  alias: Left garage door timeout
  trigger:
    platform: state
    entity_id: cover.left_door
  action:
    - delay:
        minutes: 10
    - service: cover.close_cover
      entity_id: cover.left_door

- id: right_garage_door_timeout
  alias: Right garage door timeout
  trigger:
    platform: state
    entity_id: cover.right_door
  action:
    - delay:
        minutes: 10
    - service: cover.close_cover
      entity_id: cover.right_door

- id: front_door_lock_timeout
  alias: Front door lock timeout
  trigger:
    platform: state
    entity_id: lock.front_door_locked
    from: 'locked'
    to: 'unlocked'
  action:
    - delay:
        minutes: 10
    - service: lock.lock
      entity_id: lock.front_door_locked

- id: ssl_expiry
  alias: 'SSL expiry'
  trigger:
  platform: numeric_state
  entity_id: sensor.ssl_cert_expiry
  below: 21
  action:
    service: notify.matt
    data_template:
      message: >
        Warning - SSL certificate expires in {{ trigger.to_state.state }} days
        and has not been automatically renewed!

- id: entering_away
  alias: Entering away
  trigger:
    platform: event
    event_type: call_service
    event_data:
      service_data:
        entity_id: scene.leaving_home
      domain: scene
      service: turn_on
  action:
    - service: rest_command.alarm_arm

- id: returning_home
  alias: Coming home
  trigger:
    platform: event
    event_type: call_service
    event_data:
      service_data:
        entity_id: scene.returning_home
      domain: scene
      service: turn_on
  action:
    - service: rest_command.alarm_disarm

- id: leaving
  trigger:
    # Delayed action for router-based tracker to prevent false positives.
    - platform: state
      entity_id:
        - device_tracker.brooke_phone
        - device_tracker.matt_phone
      from: home
      to: not_home
      for: '00:10:00'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.brooke_phone
        state: not_home
      - condition: state
        entity_id: device_tracker.matt_phone
        state: not_home
  action:
    service: scene.turn_on
    entity_id: scene.leaving_home

- id: returning
  trigger:
    # Delayed action for router-based tracker to prevent false positives.
    - platform: state
      entity_id:
        - device_tracker.brooke_phone
        - device_tracker.matt_phone
      from: not_home
      to: home
  action:
    service: scene.turn_on
    entity_id: scene.returning_home
